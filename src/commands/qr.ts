import {
	AttachmentBuilder,
	ChatInputCommandInteraction,
	SlashCommandBuilder
} from 'discord.js';
import { QRCodeSegment, create, toBuffer } from 'qrcode';
import { CommandHelpEntry } from '../struct/CommandHelpEntry';

export const data = new SlashCommandBuilder()
	.setName('qr')
	.setDescription('Generate a QR code from a message or link')
	.addStringOption(option => {
		return option
			.setName('text')
			.setDescription('The text/link to encode')
			.setRequired(true);
	})
	.addBooleanOption(option => {
		return option
			.setName('ephemeral')
			.setDescription('Whether the reply should be ephemeral')
			.setRequired(false);
	});

export const help = new CommandHelpEntry(
	'qr',
	'Encodes some text or a link in a QR code',
	'<text: string>'
);

export const execute = async (interaction: ChatInputCommandInteraction) => {
	await interaction.reply({
		content: 'Generating QR code...',
		ephemeral: interaction.options.getBoolean('ephemeral') ?? false
	});
	await interaction.editReply({
		content: 'Successfully generated a QR code!',
		files: [
			new AttachmentBuilder(
				await toBuffer(
					create(interaction.options.getString('text', true))
						.segments as unknown as QRCodeSegment[]
				),
				{
					description: 'QR code generated by the /qr command',
					name: 'qr.png'
				}
			)
		]
	});
};
